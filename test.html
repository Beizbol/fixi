<html lang="en">
<head>
    <title>fixi test suite</title>
    <script src="fixi.js"></script>
    <script>
        let tests = [];
        let currentTest = null;
        let passed = 0;
        let failed = 0;
        let find = (selector) => currentTest.testElt.querySelector(selector);
        function fetchMockImpl(input, init){
            if (init.signal && init.signal.aborted) {
                throw new DOMException("Aborted", "AbortError");
            }
            for (let mock of currentTest.mocks) {
                if (mock.path === input) {
                    if (typeof mock.response === 'string' || mock.response instanceof String) {
                        return Promise.resolve({text : () => Promise.resolve(mock.response)});
                    } else {
                        return Promise.resolve({text: () => Promise.resolve(mock.response(input, init))})
                    }
                }
            }
            throw `Unknown path: ${input}`;
        }
        function test(code){
            let currentScript = document.currentScript;
            let testElt = currentScript.closest('div');
            tests.push(async ()=>{
                currentTest.testElt = testElt;
                let originalFetch = window.fetch;
                window.fetch = fetchMockImpl;
                try {
                    await code();
                    testElt.classList.add("passed");
                    testElt.insertAdjacentHTML('beforeend', `<p>Passed</p>`)
                    passed++;
                    document.querySelector(".passed-info").querySelector("output").innerText = 'passed';
                } catch (e) {
                    testElt.classList.add("failed");
                    testElt.insertAdjacentHTML('beforeend', `<p>ERROR: ${e}</p>`)
                    failed++;
                    document.querySelector(".failed-info").querySelector("output").innerText = 'failed';
                } finally {
                    window.fetch = originalFetch;
                    currentTest = null;
                }
            })
        }
        function mock(path, response) {
            currentTest.mocks ||= []
            currentTest.mocks.push({path, response})
        }
        function sleep(ms) {
            return new Promise((resolve) => {
                setTimeout(resolve, ms);
            })
        }
        function assertEq(actual, expected) {
            if (expected !== actual) {
                console.error("Expected", expected, "found", actual);
                throw  `Expected ${expected} found ${actual}`
            }
        }
        function assertEqTrimmed(actual, expected) {
            if (expected !== actual?.trim()) {
                console.error("Expected", expected, "found", actual);
                throw  `Expected ${expected} found ${actual}`
            }
        }
        document.addEventListener("fx:init", (evt) => console.log(evt))
        document.addEventListener("fx:process", (evt) => console.log(evt))
        document.addEventListener("fx:before", (evt) => console.log(evt))
        document.addEventListener("fx:after", (evt) => console.log(evt))
        document.addEventListener("fx:error", (evt) => console.error(evt, evt.detail.error))
        document.addEventListener('DOMContentLoaded', async () => {
            for (let i = 0; i < document.querySelectorAll(".test").length; i++){
                const testBlock = document.querySelectorAll(".test")[i];
                testBlock.querySelector("h3").insertAdjacentHTML("beforeend", ` - <a id='test${i}' href="test.html#test${i}">run</a>`)
                let scriptElt = testBlock.querySelector("script");
                scriptElt.insertAdjacentHTML("beforebegin", `<b>Code:</b><pre></pre>`)
                scriptElt.previousElementSibling.innerText = scriptElt.innerText.replaceAll(/^ {8}/gm, '') + "\n";
            }
            for (let i = 0; i < tests.length; i++){
                if (location.hash.indexOf("#test") === 0) {
                    let index = parseInt(location.hash.substring(5));
                    if (index !== i) {
                        continue;
                    }
                }
                currentTest = tests[i];
                await currentTest();
            }
        });
    </script>
    <style>
        .test {
            padding: 8px;
            margin: 8px;
        }
        .passed {
            border: 3px solid green;
        }
        .failed {
            border: 3px solid red;
        }
        .passed-info {
            color: green;
        }
        .failed-info {
            color: red;
        }
        pre {
            padding: 4px;
            margin: 12px;
            border: 1px solid rgb(128, 128, 128);
            background-color: whitesmoke;
        }
        body.hide-passed .passed {
            display: none;
        }
    </style>
</head>
<body>

<header>
    <h1>&#x1F6B2; fixi test suite</h1>
    <div>
        <div class="passed-info">Passed: <output></output></div>
        <div class="failed-info">Failed: <output></output></div>
        <a href="javascript:document.body.classList.toggle('hide-passed')">Toggle Passed</a>
    </div>
</header>

<main>
    <section id="core">
        <h2>Core</h2>
        <div class="test">
            <h3>Test basic button works</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic target works</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo" fx-target="#output1">
                Button 1
            </button>
            <output id="output1">
                Bar
            </output>
        </div>

        <div class="test">
            <h3>Test basic target works</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 1");
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo" fx-swap="afterend">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic button with inner swap works</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test added content is live</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<button fx-action='/demo2'>Button 2</button>");
                mock("/demo2", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 2");
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test nested added content is live</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<p><button fx-action='/demo2'>Button 2</button></p>");
                mock("/demo2", "<div>Foo</div>");
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 2");
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test double-click works when drop disabled</h3>
            <script>
              test(async ()=>{
                find('button').addEventListener("fx:config", (evt)=> evt.detail.cfg.drop = false) // don't drop any reqs
                let i = 1;
                mock("/demo", ()=>`<div>Foo${i++}</div>`);
                find('button').click();
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Foo2");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test event-based throttling works</h3>
            <script>
              test(async ()=>{
                let i = 1;
                mock("/demo", ()=>`<div>Foo${i++}</div>`);
                find("button").addEventListener("fx:config", (evt)=>{
                  if (evt.detail.requests.length > 0) {
                    evt.preventDefault();
                  }
                })
                find('button').click();
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Foo1");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test event-based throttling w/delay works</h3>
            <script>
              test(async ()=>{
                let i = 1;
                mock("/demo", ()=>`<div>Foo${i++}</div>`);
                find("button").addEventListener("fx:config", (evt)=>{
                  if (evt.detail.requests.length > 0) {
                    evt.preventDefault();
                  }
                })
                find('button').click();
                await sleep(50);
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Foo2");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test event-based aborting works</h3>
            <script>
              test(async ()=>{
                mock("/demo", ()=>`<div>Foo</div>`);
                find("button").addEventListener("fx:before", (evt)=>{
                  evt.detail.cfg.abort();
                })
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 1");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test event-based disabling works</h3>
            <script>
              test(async ()=>{
                let i = 1;
                mock("/demo", ()=>`<div>Foo${i++}</div>`);
                find("button").addEventListener("fx:before", (evt)=>{
                  evt.target.disabled = true;
                })
                find("button").addEventListener("fx:finally", (evt)=>{
                  evt.target.disabled = true;
                })
                find('button').click();
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Foo1");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic form works</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                find('form').requestSubmit();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <form id="f1" fx-action="/demo" fx-method="get">
                Form1
            </form>
        </div>

        <div class="test">
            <h3>Test confirm can disable</h3>
            <script>
              test(async ()=>{
                let allow = false;
                mock("/demo", ()=>`<div>Foo</div>`);
                find("button").addEventListener("fx:config", (evt)=>{
                  evt.detail.cfg.confirm = ()=>allow
                })
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 1");
                allow = true;
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test confirm-based debouncing works as expected</h3>
            <script>
              test(async ()=>{
                mock("/demo", ()=>`<div>Foo</div>`);
                let latestPromise = null;
                find("button").addEventListener("fx:config", (evt)=>{
                  evt.detail.cfg.confirm = ()=>{
                    let currentPromise = latestPromise = new Promise((resolve)=>{
                      setTimeout(()=>resolve(currentPromise === latestPromise), 200)
                    })
                    return currentPromise
                  }
                })
                find('button').click();
                await sleep(50);
                assertEq(find('button')?.innerText, "Button 1");
                await sleep(200);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo" fx-method="get" fx-swap="innerHTML">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test can disable transitions</h3>
            <script>
              test(async ()=>{
                mock("/demo", ()=>`<div>Foo</div>`);
                find("button").addEventListener("fx:before", (evt)=>{
                  evt.detail.cfg.transition = false
                })
                find('button').click();
                await sleep(50);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Moving a node does not reinitialize it</h3>
            <script>
              test(async ()=>{
                mock("/demo", ()=>`<div>Foo</div>`);
                let requests = 0;
                find("button").addEventListener("fx:before", ()=>{
                  requests++
                })
                let btn = find('button')
                // move button to the end of the div
                btn.parentElement.insertBefore(btn, null)
                await sleep(50);
                btn.click();
                await sleep(50);
                assertEq(requests, 1);
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
            <p>A Paragraph</p>
        </div>

        <div class="test">
            <h3>Lazy loading works as expected using fx:inited</h3>
            <script>
              test(async ()=>{
                mock("/demo", `<div><p fx-action="/demo2" fx-trigger="fx:inited">Foo</p></div>`);
                mock("/demo2", `Bar`);
                let btn = find('button')
                btn.click();
                await sleep(50);
                assertEq(btn.innerText, "Bar");
              })
            </script>
            <button fx-action="/demo" fx-swap="innerHTML">
                Button 1
            </button>
        </div>
    </section>

    <section id="events">
        <h2>Events</h2>

        <div class="test">
            <h3>Test basic fx:before triggered</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let triggered = false;
                find('button').addEventListener('fx:config', () => {
                  triggered = true;
                })
                find('button').click();
                await sleep(50);
                assertEq(triggered, true);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic fx:before triggered</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let triggered = false;
                find('button').addEventListener('fx:before', () => {
                  triggered = true;
                })
                find('button').click();
                await sleep(50);
                assertEq(triggered, true);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic fx:after triggered</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let triggered = false;
                find('button').addEventListener('fx:after', () => {
                  triggered = true;
                })
                find('button').click();
                await sleep(50);
                assertEq(triggered, true);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic fx:finally triggered</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let triggered = false;
                find('button').addEventListener('fx:finally', () => {
                  triggered = true;
                })
                find('button').click();
                await sleep(50);
                assertEq(triggered, true);
                assertEq(find('div')?.innerText, "Foo");
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test fx:before can cancel request</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let triggered = false;
                find('button').addEventListener('fx:before', (evt) => {
                  triggered = true;
                  console.log(evt);
                  evt.preventDefault();
                })
                find('button').click();
                await sleep(50);
                assertEq(triggered, true);
                assertEq(find('div'), null);
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test evt.detail.cfg.swap can be a function</h3>
            <script>
              test(async ()=>{
                mock("/demo", "<div>Foo</div>");
                let swapped = false;
                find('button').addEventListener('fx:before', (evt) => {
                  evt.detail.cfg.swap = ()=>{
                    swapped = true;
                  }
                })
                find('button').click();
                await sleep(50);
                assertEq(swapped, true);
                assertEq(find('div'), null);
              })
            </script>
            <button fx-action="/demo">
                Button 1
            </button>
        </div>

        <div class="test">
            <h3>Test basic fx:inited triggered</h3>
            <script>
              test(async ()=>{
                assertEq(find('button').classList.contains("fx-inited"), true);
                assertEq(find('button').parentElement.classList.contains("fx-inited"), false);
              })
            </script>
            <button fx-action="/demo" fx-trigger="fx:inited">
                Button 1
            </button>
            <script>
                let button = document.currentScript.previousElementSibling
                button.addEventListener("fx:before", (evt)=>{
                  evt.preventDefault(); // don't make the request
                })
                button.addEventListener("fx:inited", ()=>{
                  button.classList.add("fx-inited")
                })
                button.parentElement.addEventListener("fx:inited", ()=>{
                  button.classList.add("fx-inited")
                })
            </script>
        </div>

    </section>

</main>

<footer>
    <h2>Scratch</h2>

    <form fx-action="/foo?" fx-swap="beforeend">
        <label>Foo
            <input name="foo" value="bar">
        </label>
        <button name="blah">
            Foo
        </button>
    </form>
</footer>


</body>
</html>
